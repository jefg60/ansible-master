---

- name: git checkout anmad
  git:
    repo: https://github.com/jefg60/anmad.git
    dest: /srv/anmad
    clone: yes
    version: 0.13.1
  tags: anmad
  notify:
    - reload anmad

- name: deploy ssh-askpass script
  template:
    src: ssh-askpass.j2
    dest: /usr/bin/ssh-askpass
    owner: root
    group: root
    mode: 0755
  when: master_ansible_user_vaultfile is defined
  tags: anmad

- name: create anmad conf dir
  file:
    path: /etc/anmad/conf.d/
    state: directory
    mode: 0755
    owner: root
    group: root
  tags: anmad

- name: symlink anmad_run config to anmad_restart
  file:
    src: /etc/anmad/conf.d/anmad_run.py
    dest: /etc/anmad/conf.d/anmad_restart.py
    owner: root
    group: root
    state: link

- name: deploy anmad config files
  template:
    src: anmad.conf.j2
    dest: "/etc/anmad/conf.d/{{ item }}.py"
    mode: 0644
    owner: root
    group: root
  loop:
    - anmad_buttons
    - anmad_run
  tags: anmad
  notify:
    - reload anmad

- name: deploy anmad rsyslog conf
  copy:
    src: "{{ item }}-rsyslog.conf"
    dest: /etc/rsyslog.d/
    mode: 0644
    owner: root
    group: root
  loop:
    - anmad_buttons
    - anmad_run
  tags: anmad
  notify:
    - restart rsyslog

- name: deploy anmad .service files
  copy:
    src: "{{ item }}.service"
    dest: /etc/systemd/system/
    mode: 0644
    owner: root
    group: root
  loop:
    - anmad_run
  tags: anmad
  notify:
    - systemctl daemon-reload
    - restart anmad

- name: ensure anmad systemd services are running
  systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    masked: false
  loop:
    - anmad_run
    - redis

- name: enable apache2 ssl module
  apache2_module:
    state: present
    name: ssl

- name: deploy anmad-buttons apache configfile
  template:
    src: anmad-buttons-wsgi.conf
    dest: /etc/apache2/sites-available
    owner: root
    group: root
    mode: 0644
  notify:
    - reload apache

- name: symlink anmad-buttons apache config to sites-enabled
  file:
    src: /etc/apache2/sites-available/anmad-buttons-wsgi.conf
    dest: /etc/apache2/sites-enabled/anmad-buttons-wsgi.conf
    owner: root
    group: root
    state: link
  notify:
    - reload apache

- name: create /etc/htpasswd folder
  file:
    path: /etc/htpasswd
    state: directory
    owner: root
    group: root
    mode: 0755

# command is used here because htpasswd module doesnt work with bcrypt
- name: Create admin user in htpasswd file with bcrypt
  command: "htpasswd -b -c -B -C 11 /etc/htpasswd/.htpasswd \
    {{ anmad_control_username }} {{ anmad_control_password }}"
  changed_when: false
  no_log: true
